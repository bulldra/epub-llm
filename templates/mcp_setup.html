<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>MCP Server Setup - EPUB Manager</title>
		<link href="/static/css/style.css" rel="stylesheet" />
		<style>
			.setup-container {
				max-width: 800px;
				margin: 40px auto;
				padding: 20px;
			}
			.step {
				background: #f8f9fa;
				border-radius: 8px;
				padding: 20px;
				margin-bottom: 20px;
				border-left: 4px solid #007bff;
			}
			.step h3 {
				margin-top: 0;
				color: #007bff;
			}
			.code-block {
				background: #2d3748;
				color: #e2e8f0;
				padding: 15px;
				border-radius: 6px;
				overflow-x: auto;
				margin: 10px 0;
				font-family: 'Courier New', monospace;
			}
			.copy-btn {
				background: #28a745;
				color: white;
				border: none;
				padding: 5px 10px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 12px;
				margin-left: 10px;
			}
			.copy-btn:hover {
				background: #218838;
			}
			.status-indicator {
				display: inline-block;
				width: 12px;
				height: 12px;
				border-radius: 50%;
				margin-right: 8px;
			}
			.status-success {
				background: #28a745;
			}
			.status-warning {
				background: #ffc107;
			}
			.status-error {
				background: #dc3545;
			}
			.mcp-config {
				background: #f8f9fa;
				border: 1px solid #dee2e6;
				border-radius: 6px;
				padding: 15px;
				margin: 10px 0;
			}
			.nav-buttons {
				text-align: center;
				margin: 30px 0;
			}
			.nav-buttons a {
				display: inline-block;
				padding: 10px 20px;
				margin: 0 10px;
				background: #007bff;
				color: white;
				text-decoration: none;
				border-radius: 5px;
				transition: background-color 0.3s;
			}
			.nav-buttons a:hover {
				background: #0056b3;
			}
		</style>
	</head>
	<body>
		{% include 'partials/header.html' %}
		<div class="container">
			<h1>ğŸ“¡ MCP Server Setup Guide</h1>
			<p>
				EPUBãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’Model Context Protocol (MCP)
				ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦è¨­å®šã™ã‚‹æ‰‹é †ã§ã™ã€‚
			</p>

			<div class="setup-container">
				<!-- Step 1: Server Status -->
				<div class="step">
					<h3>ğŸ“Š Step 1: Server Status</h3>
					<p>ç¾åœ¨ã®MCPã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>

					<div id="server-status">
						<p>
							<span class="status-indicator status-warning"></span
							>ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªä¸­...
						</p>
					</div>

					<button
						onclick="checkServerStatus()"
						class="btn btn-primary">
						ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
					</button>
				</div>

				<!-- Step 2: Claude Desktop Configuration -->
				<div class="step">
					<h3>âš™ï¸ Step 2: Claude Desktopè¨­å®š</h3>
					<p>
						Claude Desktopã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«MCPã‚µãƒ¼ãƒãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚
					</p>

					<p><strong>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€:</strong></p>
					<ul>
						<li>
							<strong>macOS:</strong>
							<code
								>~/Library/Application
								Support/Claude/claude_desktop_config.json</code
							>
						</li>
						<li>
							<strong>Windows:</strong>
							<code
								>%APPDATA%\Claude\claude_desktop_config.json</code
							>
						</li>
					</ul>

					<div class="mcp-config">
						<h4>è¨­å®šå†…å®¹ã‚’ã‚³ãƒ”ãƒ¼:</h4>
						<div class="code-block" id="mcp-config-content">
							{ "mcpServers": { "epub-manager": { "command":
							"uvicorn", "args": [ "src.mcp_server:mcp_app",
							"--host", "localhost", "--port", "8001" ], "cwd":
							"<span id="current-path">{{ current_path }}</span>"
							} } }
						</div>
						<button
							onclick="copyToClipboard('mcp-config-content')"
							class="copy-btn">
							ğŸ“‹ ã‚³ãƒ”ãƒ¼
						</button>
					</div>

					<p>
						<strong>æ³¨æ„:</strong>
						<code>&lt;EPUB_MANAGER_PATH&gt;</code
						>ã‚’å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
					</p>
				</div>

				<!-- Step 3: Start Server -->
				<div class="step">
					<h3>ğŸš€ Step 3: MCPã‚µãƒ¼ãƒãƒ¼èµ·å‹•</h3>
					<p>MCPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚</p>

					<div class="code-block">
						<div>cd {{ current_path }}</div>
						<div>
							uvicorn src.mcp_server:mcp_app --host localhost
							--port 8001
						</div>
					</div>
					<button
						onclick="copyToClipboard('start-command')"
						class="copy-btn">
						ğŸ“‹ ã‚³ãƒ”ãƒ¼
					</button>

					<div style="margin-top: 15px">
						<button
							onclick="startMCPServer()"
							class="btn btn-success">
							ğŸš€ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
						</button>
						<button
							onclick="stopMCPServer()"
							class="btn btn-danger">
							â¹ ã‚µãƒ¼ãƒãƒ¼åœæ­¢
						</button>
					</div>
				</div>

				<!-- Step 4: Test Connection -->
				<div class="step">
					<h3>ğŸ§ª Step 4: æ¥ç¶šãƒ†ã‚¹ãƒˆ</h3>
					<p>MCPã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>

					<div id="test-results">
						<button
							onclick="testMCPConnection()"
							class="btn btn-info">
							ğŸ” æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
						</button>
					</div>
				</div>

				<!-- Step 5: Available Tools -->
				<div class="step">
					<h3>ğŸ›  Step 5: åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«</h3>
					<p>EPUBãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§åˆ©ç”¨å¯èƒ½ãªMCPãƒ„ãƒ¼ãƒ«ä¸€è¦§:</p>

					<ul>
						<li>
							<strong>list_epub_books()</strong> -
							EPUBæ›¸ç±ä¸€è¦§ã‚’å–å¾—
						</li>
						<li>
							<strong>get_epub_metadata(book_id)</strong> -
							æ›¸ç±ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
						</li>
						<li>
							<strong>search_epub_content(book_id, query)</strong>
							- æ›¸ç±å†…å®¹æ¤œç´¢ï¼ˆåŸºæœ¬æ©Ÿèƒ½ï¼‰
						</li>
					</ul>

					<div id="tools-test">
						<button onclick="testTools()" class="btn btn-info">
							ğŸ§ª ãƒ„ãƒ¼ãƒ«å‹•ä½œãƒ†ã‚¹ãƒˆ
						</button>
					</div>
				</div>
			</div>

			<div class="nav-buttons">
				<a href="/bookshelf_ui">ğŸ“š æ›¸æ£šã«æˆ»ã‚‹</a>
				<a href="/health">ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</a>
			</div>
		</div>

		<script>
			async function checkServerStatus() {
				const statusDiv = document.getElementById('server-status')
				statusDiv.innerHTML =
					'<p><span class="status-indicator status-warning"></span>ç¢ºèªä¸­...</p>'

				try {
					const response = await fetch('/health')
					const data = await response.json()

					if (response.ok) {
						statusDiv.innerHTML = `
                        <p><span class="status-indicator status-success"></span>ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒãƒ¼: æ­£å¸¸ç¨¼åƒ</p>
                        <p>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${data.status}</p>
                    `
					} else {
						statusDiv.innerHTML =
							'<p><span class="status-indicator status-error"></span>ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒãƒ¼: å¿œç­”ãªã—</p>'
					}
				} catch (error) {
					statusDiv.innerHTML =
						'<p><span class="status-indicator status-error"></span>ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚¨ãƒ©ãƒ¼</p>'
				}
			}

			async function startMCPServer() {
				try {
					const response = await fetch('/api/mcp/start', {
						method: 'POST',
					})
					const data = await response.json()
					alert(data.message || 'MCPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ')
				} catch (error) {
					alert('èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
				}
			}

			async function stopMCPServer() {
				try {
					const response = await fetch('/api/mcp/stop', {
						method: 'POST',
					})
					const data = await response.json()
					alert(data.message || 'MCPã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ')
				} catch (error) {
					alert('åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
				}
			}

			async function testMCPConnection() {
				const resultsDiv = document.getElementById('test-results')
				resultsDiv.innerHTML = '<p>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>'

				try {
					const response = await fetch('/api/mcp/test')
					const data = await response.json()

					if (data.success) {
						resultsDiv.innerHTML = `
                        <p><span class="status-indicator status-success"></span>MCPæ¥ç¶š: æˆåŠŸ</p>
                        <p>å¿œç­”æ™‚é–“: ${data.response_time}ms</p>
                    `
					} else {
						resultsDiv.innerHTML = `<p><span class="status-indicator status-error"></span>MCPæ¥ç¶š: å¤±æ•— - ${data.error}</p>`
					}
				} catch (error) {
					resultsDiv.innerHTML = `<p><span class="status-indicator status-error"></span>ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</p>`
				}
			}

			async function testTools() {
				const testDiv = document.getElementById('tools-test')
				testDiv.innerHTML = '<p>ãƒ„ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>'

				try {
					const response = await fetch('/api/mcp/test-tools')
					const data = await response.json()

					let html = '<h4>ãƒ„ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆçµæœ:</h4><ul>'
					for (const [tool, result] of Object.entries(data.results)) {
						const status = result.success
							? 'status-success'
							: 'status-error'
						html += `<li><span class="status-indicator ${status}"></span>${tool}: ${result.message}</li>`
					}
					html += '</ul>'

					testDiv.innerHTML = html
				} catch (error) {
					testDiv.innerHTML = `<p><span class="status-indicator status-error"></span>ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</p>`
				}
			}

			function copyToClipboard(elementId) {
				const element = document.getElementById(elementId)
				const text = element.textContent || element.innerText

				navigator.clipboard
					.writeText(text)
					.then(() => {
						alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!')
					})
					.catch((err) => {
						console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err)
						// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
						const textArea = document.createElement('textarea')
						textArea.value = text
						document.body.appendChild(textArea)
						textArea.select()
						document.execCommand('copy')
						document.body.removeChild(textArea)
						alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!')
					})
			}

			// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
			document.addEventListener('DOMContentLoaded', function () {
				checkServerStatus()
			})
		</script>
	</body>
</html>
