# Smart RAG Features

EPUB LLMアプリケーションに実装された高度なRAG機能について説明します。

## 実装された機能

### 1. ハイブリッド検索 (Hybrid Search)
**機能**: 意味検索（embedding）とキーワード検索（BM25）を組み合わせ
- **意味検索**: 文章の意味的類似性を理解
- **キーワード検索**: 正確なキーワードマッチング
- **重み調整**: クエリタイプに応じて両者の重みを動的調整

**効果**:
- 精密なキーワード検索と意味理解の両方を活用
- 日本語テキストに最適化されたトークン化
- 検索漏れの大幅な削減

### 2. Re-ranking機能
**機能**: 検索結果を複数の要因で再順位付け
- **クエリ-テキスト重複度**: クエリとの語彙的重複を評価
- **テキスト品質スコア**: 長さや構造を考慮
- **多様性ペナルティ**: 類似結果の重複を回避

**効果**:
- より関連性の高い結果を上位に表示
- 冗長な情報の削減
- バランスの取れた情報提供

### 3. クエリ拡張と理解
**機能**: ユーザークエリの理解と拡張
- **同義語展開**: 日本語の類義語を自動生成
- **LLM活用拡張**: AIによるクエリ言い換え
- **クエリ意図分析**: 質問タイプ（事実、手順、説明等）を自動判定

**効果**:
- より包括的な検索結果
- ユーザーの意図に合わせた最適化
- 検索表現の違いを吸収

### 4. コンテキスト圧縮とフィルタリング
**機能**: LLMに渡すコンテキストの最適化
- **重要文抽出**: クエリに最も関連する文を選択
- **関連度表示**: 各結果の関連度を明示
- **長さ制御**: LLMの性能を最大化する長さに調整

**効果**:
- LLMの回答品質向上
- 処理時間の短縮
- より集中的な情報提供

### 5. 書籍固有の重み付け
**機能**: 書籍メタデータを活用した関連度調整
- **タイトル/著者マッチング**: クエリとの一致度で重み付け
- **出版年考慮**: 時代性を考慮した関連度調整
- **高関連書籍の強調**: 特に関連度の高い書籍を視覚的に表示（🔥マーク）

**効果**:
- より文脈に適した結果
- 書籍の専門性を反映
- ユーザーの検索意図との整合性向上

## 適応的検索戦略

### クエリタイプ別の最適化
1. **事実確認クエリ**: キーワード検索重視
2. **手順説明クエリ**: 包括的コンテキスト重視
3. **説明要求クエリ**: 意味理解重視
4. **比較クエリ**: 多様性重視

### 使用方法

#### 基本的な使用
```python
# スマート検索の実行
context = await enhanced_epub_service.smart_search_books(
    book_ids=["book1.epub", "book2.epub"],
    query="機械学習の基礎概念について",
    top_k=10
)
```

#### MCPツールとしての使用
```python
# MCP経由での高度な検索
result = await mcp_client.call_tool("smart_search_books", {
    "book_ids": ["book1.epub", "book2.epub"],
    "query": "深層学習のアルゴリズム",
    "top_k": 15
})
```

## パフォーマンス向上

### キャッシュ機能
- **埋め込みキャッシュ**: 一度計算した埋め込みを保存
- **BM25インデックスキャッシュ**: キーワード検索インデックスを保存
- **メタデータキャッシュ**: 書籍情報を効率的に管理

### 処理の最適化
- **並列処理**: 複数書籍の同時処理
- **段階的検索**: 段階的に結果を絞り込み
- **フォールバック機能**: エラー時の安全な代替処理

## 設定とカスタマイズ

### 検索パラメータの調整
```python
strategy = {
    "top_k": 10,                    # 取得する結果数
    "semantic_weight": 0.7,         # 意味検索の重み
    "keyword_weight": 0.3,          # キーワード検索の重み
    "diversity_weight": 0.2,        # 多様性の重み
    "max_context_length": 8000      # 最大コンテキスト長
}
```

### クエリ拡張の設定
```python
expansion_config = {
    "use_synonyms": True,           # 同義語展開
    "use_llm_expansion": True,      # LLM拡張
    "max_expansions": 3             # 最大拡張数
}
```

## 今後の拡張予定

1. **学習機能**: ユーザーフィードバックからの学習
2. **個人化**: ユーザー別の検索最適化
3. **多言語対応**: 他言語での高度な検索
4. **グラフ検索**: 知識グラフを活用した関連検索

このスマートRAGシステムにより、EPUB LLMアプリケーションは従来の単純な検索を大幅に上回る性能を実現しています。